<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñ®Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8fafc;
            margin: 0;
            padding: 16px;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #1e293b;
            margin: 0;
        }
        .last-update {
            font-size: 0.9em;
            color: #64748b;
            margin-top: 4px;
        }
        .printers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            max-width: 1800px;
            margin: 0 auto;
        }
        .printer-card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;

        }
        .printer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .name {
            font-size: 1.1em;
            font-weight: 600;
            margin: 0 0 6px 0;
            color: #0f172a;
        }
        .ip {
            font-family: monospace;
            color: #0ea5e9;
            font-size: 0.95em;
            margin: 0 0 6px 0;
        }
        .model, .location {
            font-size: 0.9em;
            color: #64748b;
            margin: 2px 0;
        }
        .status-line {
            display: flex;
            align-items: center;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }
        .status-badge {
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .status-online { background: #dcfce7; color: #166534; }
        .status-offline { background: #fee2e2; color: #b91c1c; }
        .response-time {
            margin-left: auto;
            font-size: 0.85em;
            color: #4b5563;
        }
        .last-check {
            font-size: 0.8em;
            color: #94a3b8;
            margin-top: 4px;
        }
        .manual-update {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
        }
        .manual-update:hover { background: #2563eb; }
    </style>
</head>
<body>

<header>
    <h1>üñ®Ô∏è –°—Ç–∞—Ç—É—Å –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</h1>
    <div class="last-update">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="update-time">‚Äî</span></div>
    <button class="manual-update" onclick="updateStatuses()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å</button>
</header>

<div class="printers-grid" id="printers-grid">
    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ Jinja2 -->
    {% for p in printers %}
    <div class="printer-card" id="printer-{{ p.id }}">
        <div class="name">{{ p.name }}</div>
        <div class="ip">
            <a href="http://{{ p.ip }}" target="_blank" rel="noopener noreferrer"
               style="color: #0ea5e9; text-decoration: none;"
               title="–û—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–Ω—Ç–µ—Ä–∞">
                {{ p.ip }} üåê
            </a>
        </div>
        <div class="model">üñ®Ô∏è {{ p.model }}</div>
        <div class="location">üìç {{ p.location }}</div>

        <div class="status-line">
            <span class="status-badge status-{{ 'online' if p.status else 'offline' }}" id="status-{{ p.id }}">
                {{ '‚úÖ –û–Ω–ª–∞–π–Ω' if p.status else '‚ùå –û—Ñ–ª–∞–π–Ω' }}
            </span>
            <span class="response-time" id="rt-{{ p.id }}">
                {{ p.response_time }} –º—Å
            </span>
        </div>
        <div class="last-check" id="check-{{ p.id }}">
            –ü—Ä–æ–≤–µ—Ä–∫–∞: {{ p.last_check or '‚Äî' }}
        </div>
    </div>
    {% endfor %}
</div>

<script>
    let updateInProgress = false;

    function updateStatuses() {
        if (updateInProgress) return;
        updateInProgress = true;

        const now = new Date().toLocaleTimeString();
        document.getElementById('update-time').textContent = now + '‚Ä¶';

        fetch('/api/status')
            .then(res => {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            })
            .then(data => {
                data.forEach(item => {
                    const statusEl = document.getElementById(`status-${item.id}`);
                    const rtEl = document.getElementById(`rt-${item.id}`);
                    const checkEl = document.getElementById(`check-${item.id}`);

                    if (statusEl) {
                        statusEl.className = `status-badge status-${item.status ? 'online' : 'offline'}`;
                        statusEl.textContent = item.status ? '‚úÖ –û–Ω–ª–∞–π–Ω' : '‚ùå –û—Ñ–ª–∞–π–Ω';
                    }
                    if (rtEl) {
                        rtEl.textContent = item.response_time + ' –º—Å';
                    }
                    if (checkEl) {
                        checkEl.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞: ' + item.last_check;
                    }
                });

                document.getElementById('update-time').textContent = now;
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', err);
                document.getElementById('update-time').textContent = '‚ùå –û—à–∏–±–∫–∞';
            })
            .finally(() => {
                updateInProgress = false;
            });
    }

    // –ü–µ—Ä–≤–æ–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —Å–µ–∫ (—á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)
    setTimeout(updateStatuses, 1000);

    // –î–∞–ª–µ–µ ‚Äî –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(updateStatuses, 30000);
</script>

<!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div style="text-align: center; margin-bottom: 20px;">
    <button onclick="showAddForm()" style="
        background: #10b981;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 1em;
        cursor: pointer;
    ">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä</button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="modal" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
">
    <div style="
        background: white;
        padding: 24px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    ">
        <h3 id="modal-title" style="margin-top: 0;">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä</h3>
        <form id="printer-form" onsubmit="return submitForm(event)">
            <input type="hidden" id="printer-id">

            <label style="display: block; margin: 12px 0 6px;">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" id="name" required placeholder="HP LaserJet MFP"
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">

            <label style="display: block; margin: 12px 0 6px;">IP-–∞–¥—Ä–µ—Å:</label>
            <input type="text" id="ip" required placeholder="192.168.1.10"
                   pattern="^(\d{1,3}\.){3}\d{1,3}$"
                   title="–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π IPv4, –Ω–∞–ø—Ä–∏–º–µ—Ä: 192.168.1.10"
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">

            <label style="display: block; margin: 12px 0 6px;">–ú–æ–¥–µ–ª—å:</label>
            <input type="text" id="model" required placeholder="HP LaserJet Pro MFP M428fd"
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <label style="display: block; margin: 12px 0 6px;">–¢–∏–ø:</label>
            <select id="color" required
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="1">–¶–≤–µ—Ç–Ω–æ–π</option>
                <option value="0">–ß–µ—Ä–Ω–æ-–±–µ–ª—ã–π</option>
            </select>

            <label style="display: block; margin: 12px 0 6px;">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</label>
            <input type="text" id="location" required placeholder="–û—Ñ–∏—Å, –∫–∞–±. 205"
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">

            <div style="margin-top: 20px; text-align: right;">
                <button type="button" onclick="closeModal()"
                        style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 8px;">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit"
                        style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<script>
    // === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ===
    function showModal(title, printer = null) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('printer-form').reset();
    document.getElementById('printer-id').value = '';

    if (printer) {
        document.getElementById('printer-id').value = printer.id;
        document.getElementById('name').value = printer.name;
        document.getElementById('ip').value = printer.ip;
        document.getElementById('model').value = printer.model;
        document.getElementById('location').value = printer.location;
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –ø—Ä–∏–Ω—Ç–µ—Ä–∞
        document.getElementById('color').value = printer.color ? '1' : '0';
    }

    document.getElementById('modal').style.display = 'flex';
}

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    function showAddForm() {
        showModal('‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä');
    }

    function showEditForm(printer) {
        showModal('‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä', printer);
    }

    // === –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã ===
    function submitForm(e) {
        e.preventDefault();

        const id = document.getElementById('printer-id').value;
        const data = {
            name: document.getElementById('name').value.trim(),
            ip: document.getElementById('ip').value.trim(),
            model: document.getElementById('model').value.trim(),
            location: document.getElementById('location').value.trim(),
            color: document.getElementById('color').value === '1'
        };

        // –í–∞–ª–∏–¥–∞—Ü–∏—è IP (–ø—Ä–æ—Å—Ç–∞—è)
        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipPattern.test(data.ip)) {
            alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π IP-–∞–¥—Ä–µ—Å');
            return false;
        }

        const url = id ? `/api/printers/${id}` : '/api/printers';
        const method = id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(result => {
            if (result.error) {
                alert('–û—à–∏–±–∫–∞: ' + result.error);
                return;
            }

            alert(id ? '–ü—Ä–∏–Ω—Ç–µ—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!' : '–ü—Ä–∏–Ω—Ç–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!');
            closeModal();

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ (AJAX)
            loadPrinters();
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞:', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å.');
        });

        return false;
    }

    // === –£–¥–∞–ª–µ–Ω–∏–µ ===
    function deletePrinter(id, name) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä "${name}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;

        fetch(`/api/printers/${id}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(result => {
                if (result.error) {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                    return;
                }
                alert('–ü—Ä–∏–Ω—Ç–µ—Ä —É–¥–∞–ª—ë–Ω');
                loadPrinters(); // –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
            });
    }

        function loadPrinters() {
            fetch('/api/printers')
                .then(res => {
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    return res.json();
                })
                .then(printers => {
                    const grid = document.getElementById('printers-grid');

                    // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"
                    if (!printers || printers.length === 0) {
                        grid.innerHTML = `
                            <div class="empty-state" style="
                                grid-column: 1 / -1;
                                text-align: center;
                                padding: 40px 20px;
                                background: #f8fafc;
                                border-radius: 12px;
                                border: 1px dashed #cbd5e1;
                            ">
                                <div style="font-size: 3.5em; margin-bottom: 16px;">üì≠</div>
                                <h2 style="color: #475569; margin: 0 0 12px;">–ù–µ—Ç –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</h2>
                                <p style="color: #64748b; max-width: 500px; margin: 0 auto 24px;">
                                    –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤ —Å–µ—Ç–∏.
                                </p>
                                <button onclick="showAddForm()"
                                        style="
                                            background: #3b82f6;
                                            color: white;
                                            border: none;
                                            padding: 10px 28px;
                                            border-radius: 8px;
                                            font-size: 1.1em;
                                            font-weight: 500;
                                            cursor: pointer;
                                            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                                        ">
                                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä
                                </button>
                            </div>
                        `;
                        return;
                    }

                    // –ò–Ω–∞—á–µ ‚Äî —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–∞—Ä—Ç–æ—á–∫–∏ (—Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π –∫–æ–¥)
                    grid.innerHTML = printers.map(p => `
                        <div class="printer-card" id="printer-${p.id}">
                            <div class="name">${escape(p.name)}</div>
                            <div class="ip">
                                <a href="http://${escape(p.ip)}" target="_blank" rel="noopener noreferrer"
                                   style="color: #0ea5e9; text-decoration: none;"
                                   title="–û—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–Ω—Ç–µ—Ä–∞">
                                    ${escape(p.ip)} üåê
                                </a>
                            </div>
                            <div class="model">üñ®Ô∏è ${escape(p.model)}</div>
                            <div class="location">üìç ${escape(p.location)}</div>

                            <div class="status-line">
                                <span class="status-badge status-${p.status ? 'online' : 'offline'}" id="status-${p.id}">
                                    ${p.status ? '‚úÖ –û–Ω–ª–∞–π–Ω' : '‚ùå –û—Ñ–ª–∞–π–Ω'}
                                </span>
                                <span class="response-time" id="rt-${p.id}">
                                    ${p.response_time} –º—Å
                                </span>
                            </div>
                            <div class="last-check" id="check-${p.id}">
                                –ü—Ä–æ–≤–µ—Ä–∫–∞: ${p.last_check || '‚Äî'}
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                            <div style="margin-top: 12px; display: flex; gap: 6px;">
                                <button
                                    onclick="showEditForm(${JSON.stringify(p).replace(/"/g, '&quot;')})"
                                    title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                    style="
                                        flex: 1;
                                        background: #fef9c3;
                                        color: #854d0e;
                                        border: 1px solid #fde68a;
                                        padding: 6px 0;
                                        border-radius: 6px;
                                        font-size: 0.85em;
                                        cursor: pointer;
                                        transition: background 0.2s;
                                    "
                                    onmouseover="this.style.background='#fdf5b7'"
                                    onmouseout="this.style.background='#fef9c3'"
                                >
                                    ‚úèÔ∏è –†–µ–¥–∞–∫—Ç.
                                </button>
                                <button
                                    onclick="deletePrinter(${Number(p.id)}, '${escape(p.name)}')"
                                    title="–£–¥–∞–ª–∏—Ç—å"
                                    style="
                                        flex: 1;
                                        background: #fee2e2;
                                        color: #b91c1c;
                                        border: 1px solid #fecaca;
                                        padding: 6px 0;
                                        border-radius: 6px;
                                        font-size: 0.85em;
                                        cursor: pointer;
                                        transition: background 0.2s;
                                    "
                                    onmouseover="this.style.background='#fbd5d5'"
                                    onmouseout="this.style.background='#fee2e2'"
                                >
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤:', err);
                    document.getElementById('printers-grid').innerHTML = `
                        <div class="error-state" style="
                            grid-column: 1 / -1;
                            text-align: center;
                            padding: 40px;
                            color: #ef4444;
                        ">
                            ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤.<br>
                            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (F12).
                        </div>
                    `;
                });
        }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    function escape(s) {
        return String(s)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // –ó–∞–º–µ–Ω–∏ —Å—Ç–∞—Ä—ã–π render –Ω–∞ AJAX-–∑–∞–≥—Ä—É–∑–∫—É (—á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞–ª–∏)
    document.addEventListener('DOMContentLoaded', () => {
        loadPrinters();  // ‚Üê —Ç–µ–ø–µ—Ä—å —Ä–µ–Ω–¥–µ—Ä–∏–º —á–µ—Ä–µ–∑ API, –∞ –Ω–µ Jinja2

        // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π updateStatuses –∏–∑ Jinja ‚Äî –¥–µ–ª–∞–µ–º –µ–≥–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        setTimeout(() => {
            updateStatuses();
            setInterval(updateStatuses, 30000);
        }, 1000);
    });
</script>

</body>
</html>
